---
import { getCollection, type CollectionEntry } from 'astro:content';
import PostLayout from '../../../../layouts/PostLayout.astro';
import { getVersionedPostOgImage } from '../../../../utils/og';
import { SUPPORTED_LANGS, type SupportedLang } from '../../../../utils/i18n';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', ({ data }) => !data.draft);

  const translationGroups = new Map<string, CollectionEntry<'posts'>[]>();
  for (const entry of allPosts) {
    const key = entry.data.translationKey ?? entry.slug.split('/').slice(1).join('/');
    const bucket = translationGroups.get(key);
    if (bucket) {
      bucket.push(entry);
    } else {
      translationGroups.set(key, [entry]);
    }
  }

  return allPosts
    .filter((entry) => SUPPORTED_LANGS.includes(entry.data.lang as SupportedLang))
    .map((entry) => {
      const [langSegment, ...slugSegments] = entry.slug.split('/');
      const lang = langSegment as SupportedLang;
      const slugPath = slugSegments.join('/');
      const key = entry.data.translationKey ?? slugPath;
      const translations = translationGroups.get(key) ?? [];

      const alternates = Object.fromEntries(
        translations
          .filter((other) => other.id !== entry.id)
          .map((other) => {
            const otherSlug = other.slug.split('/').slice(1).join('/');
            return [other.data.lang as SupportedLang, `/${other.data.lang}/posts/${otherSlug}/`];
          })
      ) as Partial<Record<SupportedLang, string>>;

      return {
        params: {
          lang,
          slug: slugPath
        },
        props: {
          entry,
          alternates
        }
      };
    });
}

type PostEntry = CollectionEntry<'posts'>;

interface Props {
  entry: PostEntry;
  alternates: Partial<Record<SupportedLang, string>>;
}

const { entry, alternates } = Astro.props as Props;
const lang = entry.data.lang as SupportedLang;
const { Content } = await entry.render();
const siteUrl = Astro.site ?? new URL('https://dmrcv.me');
const siteLabel = siteUrl.hostname.replace(/^www\./, '');
const ogTitle = entry.data.openGraph?.title ?? entry.data.title;
const descriptionSource =
  entry.data.openGraph?.description ?? entry.data.description ?? '';
const ogDescription = descriptionSource || entry.data.title;
const ogDate = new Intl.DateTimeFormat(lang, { dateStyle: 'long' }).format(
  entry.data.date,
);
const ogKicker = lang === 'fr' ? 'Article' : 'Feature';
const { hash: ogImageHash } = await getVersionedPostOgImage({
  title: ogTitle,
  description: ogDescription,
  date: ogDate,
  kicker: ogKicker,
  siteLabel
});
---
<PostLayout
  lang={lang}
  title={entry.data.title}
  description={entry.data.description}
  date={entry.data.date}
  tags={entry.data.tags}
  alternates={alternates}
  hero={entry.data.hero}
  openGraph={entry.data.openGraph}
  ogImageHash={ogImageHash}
>
  <Content />
</PostLayout>
